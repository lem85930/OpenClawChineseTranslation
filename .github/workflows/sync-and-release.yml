# ============================================================
# OpenClaw 汉化发行版 - 稳定版发布工作流
# 武汉晴辰天下网络科技有限公司 | https://qingchencloud.com/
# ============================================================
# 
# 触发方式：
#   1. 推送 tag（格式：v*，如 v2026.1.30-zh.1）
#   2. 手动触发（用于紧急发布）
#
# 版本说明：
#   - 稳定版 (@latest)：本工作流发布，手动打 tag 触发
#   - 最新版 (@nightly)：nightly.yml 发布，每小时自动构建
# ============================================================

name: 稳定版发布

on:
  push:
    tags:
      - 'v*'  # 监听所有 v 开头的 tag
  workflow_dispatch:
    inputs:
      version:
        description: '发布版本号（如 2026.1.30-zh.1，不含 v 前缀）'
        required: true
        type: string

env:
  UPSTREAM_REPO: openclaw/openclaw
  NODE_VERSION: '22'

permissions:
  contents: write
  packages: write

jobs:
  # ==================== 稳定版构建与发布 ====================
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 确定版本号
        id: version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            # 从 tag 提取版本号（去掉 v 前缀）
            TAG_NAME="${{ github.ref_name }}"
            VERSION="${TAG_NAME#v}"
          else
            # 手动触发时使用输入的版本号
            VERSION="${{ inputs.version }}"
          fi
          
          echo "release_version=$VERSION" >> $GITHUB_OUTPUT
          echo "📦 发布版本: $VERSION"

      - name: 获取上游版本
        id: upstream
        run: |
          UPSTREAM_VERSION=$(curl -s https://registry.npmjs.org/openclaw/latest | jq -r '.version')
          echo "version=$UPSTREAM_VERSION" >> $GITHUB_OUTPUT
          echo "📦 上游版本: $UPSTREAM_VERSION"

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: 安装 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: 克隆上游代码
        run: |
          git clone --depth 1 https://github.com/${{ env.UPSTREAM_REPO }}.git openclaw
          echo "✅ 上游代码已克隆"

      - name: 应用汉化补丁
        id: apply
        run: |
          # 运行汉化并捕获输出
          OUTPUT=$(node cli/index.mjs apply --verbose 2>&1) || true
          echo "$OUTPUT"
          
          # 提取统计信息（使用 sed 替代 grep -P，兼容性更好）
          APPLIED=$(echo "$OUTPUT" | grep "总计:" | sed 's/.*应用 \([0-9]*\).*/\1/' || echo "0")
          EXISTED=$(echo "$OUTPUT" | grep "总计:" | sed 's/.*已存在 \([0-9]*\).*/\1/' || echo "0")
          FAILED=$(echo "$OUTPUT" | grep "总计:" | sed 's/.*未找到 \([0-9]*\).*/\1/' || echo "0")
          FILES_COUNT=$(echo "$OUTPUT" | grep -c "替换:" || echo "0")
          
          # 如果提取失败，设置默认值
          [ -z "$APPLIED" ] && APPLIED="0"
          [ -z "$EXISTED" ] && EXISTED="0"
          [ -z "$FAILED" ] && FAILED="0"
          
          echo "applied=$APPLIED" >> $GITHUB_OUTPUT
          echo "existed=$EXISTED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "files=$FILES_COUNT" >> $GITHUB_OUTPUT
          
          echo ""
          echo "📊 汉化统计："
          echo "   ✅ 应用规则: $APPLIED 条"
          echo "   ⏭️ 已存在: $EXISTED 条"
          echo "   ⚠️ 未匹配: $FAILED 条"
          echo "   📝 替换操作: $FILES_COUNT 次"
          echo ""
          echo "✅ 汉化补丁已应用"

      - name: 验证汉化结果
        run: |
          node cli/index.mjs verify
          echo "✅ 汉化验证通过"

      - name: 构建 OpenClaw
        working-directory: openclaw
        run: |
          pnpm install
          pnpm run build
          echo "✅ 构建完成"

      - name: 修复构建产物中的图标
        run: |
          # 内嵌 SVG 图标（替换 CDN URL）
          SVG_ICON='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 16 16" style="display:block"><rect width="16" height="16" fill="none"/><g fill="#3a0a0d"><rect x="1" y="5" width="1" height="3"/><rect x="2" y="4" width="1" height="1"/><rect x="2" y="8" width="1" height="1"/><rect x="3" y="3" width="1" height="1"/><rect x="3" y="9" width="1" height="1"/><rect x="4" y="2" width="1" height="1"/><rect x="4" y="10" width="1" height="1"/><rect x="5" y="2" width="6" height="1"/><rect x="11" y="2" width="1" height="1"/><rect x="12" y="3" width="1" height="1"/><rect x="12" y="9" width="1" height="1"/><rect x="13" y="4" width="1" height="1"/><rect x="13" y="8" width="1" height="1"/><rect x="14" y="5" width="1" height="3"/><rect x="5" y="11" width="6" height="1"/><rect x="4" y="12" width="1" height="1"/><rect x="11" y="12" width="1" height="1"/><rect x="3" y="13" width="1" height="1"/><rect x="12" y="13" width="1" height="1"/><rect x="5" y="14" width="6" height="1"/></g><g fill="#ff4f40"><rect x="5" y="3" width="6" height="1"/><rect x="4" y="4" width="8" height="1"/><rect x="3" y="5" width="10" height="1"/><rect x="3" y="6" width="10" height="1"/><rect x="3" y="7" width="10" height="1"/><rect x="4" y="8" width="8" height="1"/><rect x="5" y="9" width="6" height="1"/><rect x="5" y="12" width="6" height="1"/><rect x="6" y="13" width="4" height="1"/></g><g fill="#ff775f"><rect x="1" y="6" width="2" height="1"/><rect x="2" y="5" width="1" height="1"/><rect x="2" y="7" width="1" height="1"/><rect x="13" y="6" width="2" height="1"/><rect x="13" y="5" width="1" height="1"/><rect x="13" y="7" width="1" height="1"/></g><g fill="#081016"><rect x="6" y="5" width="1" height="1"/><rect x="9" y="5" width="1" height="1"/></g><g fill="#f5fbff"><rect x="6" y="4" width="1" height="1"/><rect x="9" y="4" width="1" height="1"/></g></svg>'
          
          # 查找并替换构建产物中的 CDN 图标
          for js_file in openclaw/dist/control-ui/assets/*.js; do
            if [ -f "$js_file" ]; then
              if grep -q "mintcdn.com" "$js_file"; then
                echo "🔧 修复图标: $js_file"
                # 使用 Python 进行安全替换（避免 sed 转义问题）
                python3 << PYEOF
import re
with open("$js_file", "r", encoding="utf-8") as f:
    content = f.read()
# 匹配 CDN 图标的 img 标签
pattern = r'<img src="https://mintcdn\.com/[^"]*pixel-lobster\.svg[^"]*" alt="OpenClaw" />'
new_content = re.sub(pattern, '''$SVG_ICON''', content)
if content != new_content:
    with open("$js_file", "w", encoding="utf-8") as f:
        f.write(new_content)
    print("✅ 图标已替换")
else:
    print("ℹ️ 未找到需要替换的图标")
PYEOF
              fi
            fi
          done
          echo "✅ 图标修复完成"

      - name: 准备发布
        run: |
          RELEASE_VERSION="${{ steps.version.outputs.release_version }}"
          
          cd openclaw
          npm version $RELEASE_VERSION --no-git-tag-version --allow-same-version || true
          
          # 修改包信息
          jq '.name = "@qingchencloud/openclaw-zh"' package.json > tmp.json && mv tmp.json package.json
          jq '.description = "OpenClaw 汉化发行版（稳定版）- 武汉晴辰天下网络科技有限公司"' package.json > tmp.json && mv tmp.json package.json
          
          # 使用中文 README
          cp ../README.md ./README.md
          echo "✅ 发布准备完成"

      - name: 发布到 npm (@latest)
        working-directory: openclaw
        run: npm publish --access public --tag latest
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 创建 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.release_version }}
          name: "🦞 OpenClaw 汉化版 v${{ steps.version.outputs.release_version }}"
          body: |
            ## 🦞 OpenClaw 汉化发行版 - 稳定版
            
            **版本**: v${{ steps.version.outputs.release_version }}
            **上游版本**: ${{ steps.upstream.outputs.version }}
            **发布类型**: 稳定版 (Stable)
            
            ---
            
            ### 📊 汉化统计
            
            | 指标 | 数量 | 说明 |
            |------|------|------|
            | ✅ 应用规则 | **${{ steps.apply.outputs.applied }}** 条 | 成功应用的翻译规则 |
            | ⏭️ 已存在 | ${{ steps.apply.outputs.existed }} 条 | 翻译已存在，跳过 |
            | ⚠️ 未匹配 | ${{ steps.apply.outputs.failed }} 条 | 源码变更导致未匹配 |
            | 📝 替换操作 | ${{ steps.apply.outputs.files }} 次 | 实际执行的替换次数 |
            
            ---
            
            ### 📦 安装方式
            
            **稳定版（推荐）：**
            ```bash
            npm install -g @qingchencloud/openclaw-zh@latest
            ```
            
            **最新版（每小时更新）：**
            ```bash
            npm install -g @qingchencloud/openclaw-zh@nightly
            ```
            
            **一键安装脚本：**
            ```bash
            # Linux/macOS
            curl -fsSL https://cdn.jsdelivr.net/gh/1186258278/OpenClawChineseTranslation@main/install.sh | bash
            
            # Windows PowerShell
            powershell -c "irm https://cdn.jsdelivr.net/gh/1186258278/OpenClawChineseTranslation@main/install.ps1 | iex"
            ```
            
            ---
            
            ### 🔗 相关链接
            
            - 🔥 官网: https://openclaw.qt.cool/
            - 📖 文档: https://github.com/1186258278/OpenClawChineseTranslation
            - 📦 npm: https://www.npmjs.com/package/@qingchencloud/openclaw-zh
            - 🌙 最新版: https://github.com/1186258278/OpenClawChineseTranslation/releases/tag/nightly
            
            ---
            
            **武汉晴辰天下网络科技有限公司** | https://qingchencloud.com/
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==================== Docker 镜像构建与推送 ====================
      - name: 准备 Docker 构建
        run: |
          # 复制 Dockerfile 和 .dockerignore 到构建目录
          cp Dockerfile openclaw/Dockerfile
          cp .dockerignore openclaw/.dockerignore 2>/dev/null || true
          
          # 验证构建产物存在
          echo "📦 检查构建产物..."
          ls -la openclaw/
          ls -la openclaw/dist/ || echo "⚠️ dist/ 目录不存在"
          ls -la openclaw/node_modules/ | head -20 || echo "⚠️ node_modules/ 目录不存在"
          
          # 确保 dist 目录存在
          if [ ! -d "openclaw/dist" ]; then
            echo "❌ 错误：dist/ 目录不存在，Docker 构建将失败"
            exit 1
          fi
          
          echo "✅ Docker 构建准备完成"

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 准备 Docker 元数据
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/openclaw-zh
          tags: |
            type=raw,value=latest
            type=raw,value=${{ steps.version.outputs.release_version }}

      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v5
        with:
          context: ./openclaw
          push: true
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: 设置镜像为公开
        run: |
          # 使用 GitHub API 将包设置为公开
          curl -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/packages/container/openclaw-zh/versions \
            -d '{"visibility":"public"}' || true
          echo "✅ Docker 镜像已推送到 ghcr.io"

      - name: 构建摘要
        run: |
          echo "## 🦞 稳定版发布完成" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| 项目 | 值 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| 版本号 | v${{ steps.version.outputs.release_version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 上游版本 | ${{ steps.upstream.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 应用规则 | ${{ steps.apply.outputs.applied }} 条 |" >> $GITHUB_STEP_SUMMARY
          echo "| 未匹配规则 | ${{ steps.apply.outputs.failed }} 条 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📦 安装方式" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**npm**: \`npm install -g @qingchencloud/openclaw-zh@latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Docker**: \`docker pull ghcr.io/${{ github.repository_owner }}/openclaw-zh:latest\`" >> $GITHUB_STEP_SUMMARY
